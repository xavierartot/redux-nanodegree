<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Udacity Todos and Goals</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
    <style>
      ul {list-style: none;}
      .todoDone {color: #ccc; text-decoration: line-through;}
    </style>
  </head>
  <body>
  <div>
      <h1>todo list</h1>
      <input id="todo" type="text" placeholder="Add Todo" />
      <button id="todoBtn">Add Todo</button>
      <ul id="todos"></ul>
    </div>
    <div>
      <h1>Goal</h1>
      <input id="goal" type="text" placeholder="Add Goal" />
      <button id="goalBtn">Add Goal</button>
      <ul id="goals"></ul>
    </div>
    <script type="text/javascript">
      // library code

      const ADD_TODO = 'ADD_TODO',
        REMOVE_TODO  = 'REMOVE_TODO',
        TOGGLE_TODO  = 'TOGGLE_TODO',
        ADD_GOAL     = 'ADD_GOAL',
        REMOVE_GOAL  = 'REMOVE_GOAL'
      // action creator function are creating action(dispatcher)
      function addToDoAction(todo) { 
        return {
          type: ADD_TODO,
          todo,// obj
        }
      }
      function removeToDoAction(id) {
        return {
          type: REMOVE_TODO,
          id,// obj
        }
      }
      function toggleToDoAction(id) {
        return {
          type: TOGGLE_TODO,
          id,// obj
        }
      }

      function addGoalAction(goal) {
        return {
          type: ADD_GOAL,
          goal,// obj
        }
      }
      function removeGoalAction(id) {
        return {
          type: REMOVE_GOAL,
          id,// obj
        }
      }

      // App
      // reducer todo
      function todos(state = [], action) {
        switch (action.type) {
        case ADD_TODO:
          return [...state, action.todo] // ex with concat: return state.concat([action.todo]) // action.todo === {...} un object
        case REMOVE_TODO:
          return state.filter(todo => todo.id !== action.id)
        case TOGGLE_TODO:
          return state.map(todo => (todo.id === action.id ? { ...todo, complete: !todo.complete } : todo))
          // ex with Assign: Object.Assign({}, todo, complete: !todo.complete))
        default: return state
        }
      }
      // reducer goals
      function goals(state = [], action) {
        switch (action.type) {
        case ADD_GOAL    : return state.concat([action.goal])
        case REMOVE_GOAL : return state.filter(goal => goal.id !== action.id)
        default          : return state
        }
      }

      // middleware function es6
      const checker = (store) => (next) => (action) => {
        console.log(action);
        console.log(action.todo);
        console.log(action.todo.name);
        if (
        action.type === ADD_TODO && 
        action.todo.name.toLowerCase().includes('bitcoin')
        ) {
          return alert("Nope, That's a bad idea")
        }
        if (
        action.type === ADD_GOAL &&
        action.goal.name.toLowerCase().includes('bitcoin')
        ) {
          return alert("Nope, That's a bad idea")
        }
       // next manage for a different middleWare or dispatch method
       return next(action) // next replace store.dispatch(action)
      }
      // middleware function 
     //function checker(store) {
       //return function (next) {
         //return function (action) {
            //console.log(action);
            //console.log(action.todo);
            //console.log(action.todo.name);
            //if (
            //action.type === ADD_TODO && 
            //action.todo.name.toLowerCase().includes('bitcoin')
            //) {
              //return alert("Nope, That's a bad idea")
            //}
            //if (
            //action.type === ADD_GOAL &&
            //action.goal.name.toLowerCase().includes('bitcoin')
            //) {
              //return alert("Nope, That's a bad idea")
            //}
           //// next manage for a different middleWare or dispatch method
           //return next(action) // next replace store.dispatch(action)
         //}
       //}
     //}

      const store = Redux.createStore(Redux.combineReducers({ 
        todos,
        goals,
      }), Redux.applyMiddleware(checker))

      //listener
      store.subscribe(() => { //the anonymous function is passed as an argument
        //console.log('The new state is: ', store.getState())
        const {todos, goals} = store.getState()
        document.querySelector('#goals').innerHTML = ''
        document.querySelector('#todos').innerHTML = ''
        todos.forEach(addTodoToDom) // add todo.name with li element in ul#todos
        goals.forEach(addGoalToDom) // add todo.name with li element in ul#todos
      })

      const randomId = () => Math.random().toString(6).substr(-8)
      //Dom code
      function createRemoveButton(onClick) {
        const removeBtn = document.createElement('button')
        removeBtn.innerHTML = 'X'
        removeBtn.addEventListener('click', onClick )
        return removeBtn
        
      }
      function addTodoToDom(todo) { // replaced by an anonimous function
        const newElement = document.createElement("li"),
          removeBtn = createRemoveButton (() => {
            store.dispatch(  removeToDoAction(todo.id) ) //add the middleware
          })
        newElement.innerHTML = todo.name
        newElement.appendChild(removeBtn )
        //newElement.style.textDecoration = todo.complete ? 'line-through': 'none' 
        todo.complete ? newElement.classList.add('todoDone'): newElement.classList.remove('todoDone')
        newElement.addEventListener('click', () => {
          store.dispatch( toggleToDoAction(todo.id) ) //add the middleware
        })
        console.log(store.getState());
        document.querySelector('#todos').appendChild(newElement)
      }
      function addGoalToDom(goal) {
        let node = document.createElement("li")
        var text = document.createTextNode(goal.name)
        node.appendChild(text)
        document.querySelector('#goals')
          .appendChild(node)
      }

      function addTodo() {
        const input = document.querySelector('#todo'),
          name = input.value
        input.value = ''
        if (name !== '') {
          store.dispatch(addToDoAction({
            id: randomId(),
            name,
            complete: false,
          }))
        }
      }

      function addGoal() {
        let input = document.querySelector('#goal')
        name = input.value
        input.value = ''
        store.dispatch(addGoalAction({
          id: randomId(),
          name,
        }))
      }

      document.querySelector('#todoBtn').addEventListener('click', addTodo)
      document.querySelector('#goalBtn').addEventListener('click', addGoal)

        
    </script>
  </body>
</html>
