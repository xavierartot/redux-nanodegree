<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Udacity Todos and Goals</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js'></script>
    <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <script src="https://tylermcginnis.com/goals-todos-api/index.js"></script>
    <style>
      ul {list-style: none;}
      .todoDone {color: #ccc; text-decoration: line-through;}
    </style>
  </head>
  <body>
    <div id="app">
    </div>
    <script type="text/javascript">
      // library code
      const ADD_TODO = 'ADD_TODO',
        REMOVE_TODO  = 'REMOVE_TODO',
        TOGGLE_TODO  = 'TOGGLE_TODO',
        ADD_GOAL     = 'ADD_GOAL',
        REMOVE_GOAL  = 'REMOVE_GOAL',
        RECEIVE_DATA  = 'RECEIVE_DATA'
      // action creator function are use in store.dispatcher(...)
      function addToDoAction(todo) { 
        return {
          type: ADD_TODO,
          todo,// obj
        }
      }
      function removeToDoAction(id) {
        return {
          type: REMOVE_TODO,
          id,// obj
        }
      }
      function toggleToDoAction(id) {
        return {
          type: TOGGLE_TODO,
          id,// obj
        }
      }

      function addGoalAction(goal) {
        return {
          type: ADD_GOAL,
          goal,// obj
        }
      }
      function removeGoalAction(id) {
        return {
          type: REMOVE_GOAL,
          id,// obj
        }
      }
      function receiveDataAction(todos, goals) {
        return {
          type: RECEIVE_DATA,
          todos,
          goals,
        }
      }

      // App
      // function reducer todo
      function todos(state = [], action) {
        switch (action.type) {
        case ADD_TODO:
          return [...state, action.todo] // ex with concat, add action.todo in array: return state.concat([action.todo]) 
        case REMOVE_TODO:
          return state.filter(todo => todo.id !== action.id)
        case TOGGLE_TODO:
          return state.map(todo => (todo.id === action.id ? { ...todo, complete: !todo.complete } : todo))
          // ex with Assign: Object.Assign({}, todo, complete: !todo.complete))
        case RECEIVE_DATA: 
          return action.todos //load data todos, state[] is an empty array
        default: return state
        }
      }
      // reducer goals
      function goals(state = [], action) {
        switch (action.type) {
        case ADD_GOAL     : return state.concat([action.goal])
        case REMOVE_GOAL  : return state.filter(goal => goal.id !== action.id)
        case RECEIVE_DATA : return action.goals //load data goals, state[] is an empty array
        default           : return state
        }
      }
      //reducer loading, we add a booleen loading to the state
      function loading(state = true, action) {
        switch (action.type ) {
          case RECEIVE_DATA : return false 
          default: return state
        }
      }

      // middleware function es6
      const checker = (store) => (next) => (action) => {
        if ( action.type === ADD_TODO &&  action.todo.name.toLowerCase().includes('bitcoin') ) {
          return alert("Nope, That's a bad idea")
        }
        if (action.type === ADD_GOAL && action.goal.name.toLowerCase().includes('bitcoin') ) {
          return alert("Nope, That's a bad idea")
        }

       // next manage for a different middleWare or dispatch method
       return next(action) // next replace store.dispatch( method ) 
      }

      const logger  = (store) => (next) => (action) => {
        console.group(action.type)
          console.log('The action code: ', action)
          const result = next(action) // next() redux called store.dispatch(action) to dispatch the reducer
          console.log('The new state: ', store.getState())
        console.groupEnd()
        return result
      }
      //signature 
      //const store = Redux.createStore( <reducer-function>, <middleware-functions> )
      const store = Redux.createStore(Redux.combineReducers({ 
        todos, //function
        goals,
        loading,
      }), Redux.applyMiddleware(checker, logger)) //signature: applyMiddleware(...middlewares)
      const randomId = () => Math.random().toString(6).substr(-8)
    </script>

    <!--react app-->
    <script type='text/babel'>
      function List(props) {
        return (
          <div>
            <ul>
            {
              props.items.map( element => (
                <li key={element.id}>
                  <span
                    onClick={() => props.toggle && props.toggle(element.id )} /* if props.toggle exist then call the method */
                    style={{textDecoration: element.complete?'line-through':'none' }}
                >{element.name}</span>
                  <button 
                    onClick={ () => props.remove(element) }>
                    X
                  </button>
                </li>
              ))
            }
            </ul>
          </div>
        )
      }
      class Todos extends React.Component {
        addItem = (event) => {
          event.preventDefault()
          //let's work with ref
          const name = this.varInput.value 
          this.varInput.value = '' 
          //dispatch in the store
          this.props.store.dispatch(addToDoAction({
            id: randomId(),
            name,
            complete: false,
          }))
        }
        removeItem = (todo) => {
          API.deleteTodo(todo.id) //delete in the API
            .then( () => {
              this.props.store.dispatch( removeToDoAction(todo.id) ) // dispatch the delete method
            }) 
          )
        }
        toggleItem = (id) => {
          this.props.store.dispatch( toggleToDoAction(id) )
        }
        render() {
          { console.log(this.props.store) }
          return (
            <div className='todos'>
              <h2>Todos</h2>
              <input 
                type="text" 
                placholder='ddd' 
                ref={ (i) => this.varInput = i} 
              />
              <button onClick={this.addItem}>Add</button>
              <List 
                toggle={this.toggleItem}
                items={this.props.todos} 
                remove={this.removeItem}/>
            </div>
          );
        }
      }

      class Goals extends React.Component {
        addItem = (event) => {
          event.preventDefault()
          const name = this.varInput.value  
          this.varInput.value =''
          this.props.store.dispatch(addGoalAction({
            id: randomId(),
            name,
          }))
        }
        removeItem = (goal) => {
          this.props.store.dispatch( removeGoalAction(goal.id) )
        }
        render() {
          return (
            <div className='goals'>
              <h2>Goals </h2>
              <input 
                type="text"
                placeholder='goals...'
                ref={(input) => { this.varInput  = input }}
                />
              <button onClick={this.addItem}>Add</button>
              <List items={this.props.goals} remove={this.removeItem}/>
            </div>
          );
        }
      }

      class App extends React.Component { //container component
        componentDidMount() {
          const {store} = this.props

          // load the datas
          Promise.all([
            API.fetchTodos(),
            API.fetchGoals()
          ]).then(([ todos, goals ]) => {
            store.dispatch(receiveDataAction(todos, goals))
          })
 
          store.subscribe( () => this.forceUpdate() ) // force to render the render()
        }
        render() {
          const {store} = this.props
          const {todos,goals,loading} = store.getState()

          if (loading === true) {
            return <h1>loading</h1>
          }

          return (
            <div className='App'>
              <h1>React</h1>
              <Todos todos={todos} store={this.props.store}/>
              <Goals goals={goals} store={this.props.store}/>
            </div>
          );
        }
      }
      ReactDOM.render(
        <App store={store}/>, 
        document.getElementById('app')
      )
    </script>
  </body>
</html>
