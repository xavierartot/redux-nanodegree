<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Udacity Todos Goals</title>
  <style>
  ul {list-style: none;}
  .todoDone {color: #ccc; text-decoration: line-through;}
  </style>
  </head>
  <body>
  <div>
      <h1>todo list</h1>
      <input id="todo" type="text" placeholder="Add Todo" />
      <button id="todoBtn">Add Todo</button>
      <ul id="todos"></ul>
    </div>
    <div>
      <h1>Goal</h1>
      <input id="goal" type="text" placeholder="Add Goal" />
      <button id="goalBtn">Add Goal</button>
      <ul id="goals"></ul>
    </div>
    <script type="text/javascript">
      // library code
      function createStore(reducer) {
        // The store should have four parts
        // 1 - state tree
        let state,
          listeners = []

        const getState = () => state // 2 Get the state.
        // 3 Listen to change on the state.
        const subscribe = (listener) => {  //listener is a function anonymous AKA callback or Higher Order Function
          listeners.push(listener)
          return () => {
            listeners = listeners.filter(e => e !== listener)
          }
        }
        // 4 updtate the state with DISPATCH function
        const dispatch = (action) => { // action = is an object, {...}
          state = reducer(state, action) //the method reducer return the global state
          listeners.forEach(listener => listener()) // execute the closure listener() in subscribe()
        }
        return {// mandatory return an object
          getState,
          subscribe,
          dispatch,
        }
      }

      const ADD_TODO = 'ADD_TODO',
        REMOVE_TODO = 'REMOVE_TODO',
        TOGGLE_TODO = 'TOGGLE_TODO',
        ADD_GOAL = 'ADD_GOAL',
        REMOVE_GOAL = 'REMOVE_GOAL'
      // action creator function are creating action(dispatcher)
      function addToDoAction(todo) {
        return {
          type: ADD_TODO,
          todo,
        }
      }
      function removeToDoAction(id) {
        return {
          type: REMOVE_TODO,
          id,
        }
      }
      function toggleToDoAction(id) {
        return {
          type: TOGGLE_TODO,
          id,
        }
      }
      function addGoalAction(goal) {
        return {
          type: ADD_GOAL,
          goal,
        }
      }
      function removeGoalAction(id) {
        return {
          type: REMOVE_GOAL,
          id,
        }
      }

      // App
      // reducer todo
      function todos(state = [], action) {
        switch (action.type) {
        case ADD_TODO:
          // return state.concat([action.todo]) // action.todo === {...} un object
          return [...state, action.todo]
        case REMOVE_TODO:
          return state.filter(todo => todo.id !== action.id)
        case TOGGLE_TODO:
          return state.map(todo => (todo.id === action.id ? { ...todo, complete: !todo.complete } : todo))
          // Object.Assign({}, todo, complete: !todo.complete))
        default: return state
        }
      }
      // reducer goals
      function goals(state = [], action) {
        switch (action.type) {
        case ADD_GOAL:
          return state.concat([action.goal])
        case REMOVE_GOAL:
          return state.filter(goal => goal.id !== action.id)
        default: return state
        }
      }

      function app(state = {}, action) {
        return {
          todos: todos(state.todos, action), // {...}
          goals: goals(state.goals, action), // {...}
        }
      }
      const store = createStore(app)

      //listener
      store.subscribe(() => { //the anonymous function is passed as an argument
        //console.log('The new state is: ', store.getState())
        const {todos, goals} = store.getState()
        document.querySelector('#goals').innerHTML = ''
        document.querySelector('#todos').innerHTML = ''
        todos.forEach(addTodoToDom) // add todo.name with li element in ul#todos
        goals.forEach(addGoalToDom) // add todo.name with li element in ul#todos
      })

      // const unSubscribe = store.subscribe(() => {
      // console.log('T...s: ', store.getState())
      // })
      // unSubscribe()// execute the return with the fn anonyme

      // dispatch handle action object
      //store.dispatch(addGoalAction({
      //  id: 0,
      //  name: 'work everyday',
      //}))
      //store.dispatch(addGoalAction({
      //  id: 4,
      //  name: 'work ...',
      //}))
      //store.dispatch(removeGoalAction(1))
      //store.dispatch(addToDoAction({
      //  id: 3,
      //  name: 'Learn Redux',
      //  complete: false,
      //}))
      //store.dispatch(toggleToDoAction(2))

      const randomId = () => Math.random().toString(6).substr(-8)
      //Dom code
      function createRemoveButton(onClick) {
        const removeBtn = document.createElement('button')
        removeBtn.innerHTML = 'X'
        removeBtn.addEventListener('click', onClick )
        return removeBtn
        
      }
      function addTodoToDom(todo) { // replaced by an anonimous function
        const newElement = document.createElement("li"),
        newElement.innerHTML = todo.name
          removeBtn = createRemoveButton (() => {
            store.dispatch( removeToDoAction(todo.id) )
          })
        newElement.appendChild(removeBtn )
        //newElement.style.textDecoration = todo.complete ? 'line-through': 'none' 
        todo.complete ? newElement.classList.add('todoDone'): newElement.classList.remove('todoDone')
        newElement.addEventListener('click', () => {
          store.dispatch(toggleToDoAction(todo.id))
        })
        document.querySelector('#todos')
          .appendChild(newElement)
      }
      function addGoalToDom(goal) {
        let node = document.createElement("li")
        var text = document.createTextNode(goal.name)
        node.appendChild(text)
        document.querySelector('#goals')
          .appendChild(node)
      }

      function addTodo() {
        const input = document.querySelector('#todo'),
          name = input.value
        input.value = ''
        if (name !== '') {
          store.dispatch(addToDoAction({
            id: randomId(),
            name,
            complete: false,
          }))
        }
      }

      function addGoal() {
        let input = document.querySelector('#goal')
        name = input.value
        input.value.trim() = ''
        store.dispatch(addGoalAction({
          id: randomId(),
          name,
        }))
      }

      document.querySelector('#todoBtn').addEventListener('click', addTodo)
      document.querySelector('#goalBtn').addEventListener('click', addGoal)

        
    </script>
  </body>
</html>
